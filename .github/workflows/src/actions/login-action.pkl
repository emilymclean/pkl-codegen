open module docker.login_action

import "package://github.com/emilymclean/pkl-github-actions/releases/download/v0.1.0-alpha.96/pkl-github-actions@0.1.0-alpha.96#/actions.pkl" as pklaction

hidden const ACTION_CALL = "docker/login-action@v3"

/// Docker Login
///
/// GitHub Action to login against a Docker registry
class ActionInput {

    /// Server address of Docker registry. If not set then will default to Docker Hub
    registry: Any? = null

    /// Username used to log against the Docker registry
    username: Any? = null

    /// Password or personal access token used to log against the Docker registry
    password: Any? = null

    /// Specifies whether the given registry is ECR (auto, true or false)
    /// Default value if null is "auto"
    ecr: Any? = null

    /// Log out from the Docker registry at the end of a job
    /// Default value if null is "true"
    logout: Any? = null

}

/// A "class as function", use this to construct a yaml or pkl-github-actions output.
/// To use, run `new Step { ... }.yaml`
class Step {
    id: String? = null
    name: String? = null
    `if`: String? = null
    env: Mapping<String, Any>? = null
    inputs: ActionInput? = null

    fixed yaml = new {
        ["id"] = id
        ["name"] = name
        ["uses"] = ACTION_CALL
        ["if"] = `if`
        ["env"] = env
        ["with"] = if(inputs != null) new {
            ["registry"] = inputs.registry
            ["username"] = inputs.username
            ["password"] = inputs.password
            ["ecr"] = inputs.ecr
            ["logout"] = inputs.logout
        } else null
    }
    fixed github_actions = create_github_action(this)

}

/// A convenience function to get a yaml step. If you need parameters besides id, name, and inputs,
/// use the "class-as-function"
const function Step(_id: String?, _name: String?, _inputs: ActionInput?) =
    Yaml(_id, _name, _inputs)

/// A convenience function to get a yaml step. If you need parameters besides id, name, and inputs,
/// use the "class-as-function"
const function Yaml(_id: String?, _name: String?, _inputs: ActionInput?) =
    new Step {
        id = _id
        name = _name
        inputs = _inputs
    }.yaml

/// A convenience function to get a github_actions step. If you need parameters besides id, name, and inputs,
/// use the "class-as-function"
const function GithubAction(_id: String?, _name: String?, _inputs: ActionInput?) =
    new Step {
        id = _id
        name = _name
        inputs = _inputs
    }.github_actions


local const function create_github_action(step: Step) = new pklaction.ActionStep {
    id = step.id
    name = step.name
    `if` = step.`if`
    env = step.env
    uses = ACTION_CALL
    with = if (step.inputs != null) new Mapping {
        ["registry"] = step.inputs.registry
        ["username"] = step.inputs.username
        ["password"] = step.inputs.password
        ["ecr"] = step.inputs.ecr
        ["logout"] = step.inputs.logout
    } else null
}